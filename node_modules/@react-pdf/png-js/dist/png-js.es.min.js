import fs from"fs";import zlib from"zlib";var range=function(t,e,a){for(var r=[],s=t<e,i=a?s?e+1:e-1:e,n=t;s?n<i:n>i;s?n++:n--)r.push(n);return r},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)},PNG=function(){function t(e){var a=this;classCallCheck(this,t);var r=void 0;for(this.data=e,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.text={};;){var s,i=this.readUInt32();switch(function(){var t=[];for(r=0;r<4;r++)t.push(String.fromCharCode(a.data[a.pos++]));return t}().join("")){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"PLTE":this.palette=this.read(i);break;case"IDAT":for(r=0,s=i;r<s;r++)this.imgData.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(i);var n,h,o=255-this.transparency.indexed.length;if(o>0)for(r=0,n=0<=(h=o);n?r<h:r>h;n?r++:r--)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(i)[0];break;case 2:this.transparency.rgb=this.read(i)}break;case"tEXt":var l=this.read(i),c=l.indexOf(0),u=String.fromCharCode.apply(String,toConsumableArray(Array.from(l.slice(0,c)||[])));this.text[u]=String.fromCharCode.apply(String,toConsumableArray(Array.from(l.slice(c+1)||[])));break;case"IEND":this.colors=function(){switch(a.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}(),this.hasAlphaChannel=[4,6].includes(this.colorType);var d=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*d,this.colorSpace=function(){switch(a.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}(),void(this.imgData=new Buffer(this.imgData));default:this.pos+=i}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return createClass(t,null,[{key:"decode",value:function(e,a){return fs.readFile(e,function(e,r){return new t(r).decode(function(t){return a(t)})})}},{key:"load",value:function(e){return new t(fs.readFileSync(e))}}]),createClass(t,[{key:"read",value:function(t){var e=this;return range(0,t,!1).map(function(t){return e.data[e.pos++]})}},{key:"readUInt32",value:function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}},{key:"readUInt16",value:function(){return this.data[this.pos++]<<8|this.data[this.pos++]}},{key:"decodePixels",value:function(t){var e=this;return zlib.inflate(this.imgData,function(a,r){if(a)throw a;for(var s=e.pixelBitlength/8,i=s*e.width,n=new Buffer(i*e.height),h=r.length,o=0,l=0,c=0;l<h;){var u,d,f,p,v,y,g,b,m,k;switch(r[l++]){case 0:for(f=0,y=i;f<y;f++)n[c++]=r[l++];break;case 1:for(f=0,g=i;f<g;f++)u=r[l++],p=f<s?0:n[c-s],n[c++]=(u+p)%256;break;case 2:for(f=0,b=i;f<b;f++)u=r[l++],d=(f-f%s)/s,v=o&&n[(o-1)*i+d*s+f%s],n[c++]=(v+u)%256;break;case 3:for(f=0,m=i;f<m;f++)u=r[l++],d=(f-f%s)/s,p=f<s?0:n[c-s],v=o&&n[(o-1)*i+d*s+f%s],n[c++]=(u+Math.floor((p+v)/2))%256;break;case 4:for(f=0,k=i;f<k;f++){var w,C;u=r[l++],d=(f-f%s)/s,p=f<s?0:n[c-s],0===o?v=C=0:(v=n[(o-1)*i+d*s+f%s],C=d&&n[(o-1)*i+(d-1)*s+f%s]);var A=p+v-C,x=Math.abs(A-p),D=Math.abs(A-v),I=Math.abs(A-C);w=x<=D&&x<=I?p:D<=I?v:C,n[c++]=(u+w)%256}break;default:throw new Error("Invalid filter algorithm: "+r[l-1])}o++}return t(n)})}},{key:"decodePalette",value:function(){for(var t=this.palette,e=this.transparency.indexed||[],a=new Buffer(e.length+t.length),r=0,s=(t.length,0),i=0,n=t.length;i<n;i+=3){var h;a[r++]=t[i],a[r++]=t[i+1],a[r++]=t[i+2],a[r++]=null!=(h=e[s++])?h:255}return a}},{key:"copyToImageData",value:function(t,e){var a=void 0,r=void 0,s=this.colors,i=null,n=this.hasAlphaChannel;this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),s=4,n=!0);var h=(null!=t?t.data:void 0)||t,o=h.length,l=i||e,c=a=0;if(1===s)for(;c<o;){r=i?4*e[c/4]:a;var u=l[r++];h[c++]=u,h[c++]=u,h[c++]=u,h[c++]=n?l[r++]:255,a=r}else for(;c<o;)r=i?4*e[c/4]:a,h[c++]=l[r++],h[c++]=l[r++],h[c++]=l[r++],h[c++]=n?l[r++]:255,a=r}},{key:"decode",value:function(t){var e=this,a=new Buffer(this.width*this.height*4);return this.decodePixels(function(r){return e.copyToImageData(a,r),t(a)})}}]),t}();export default PNG;
